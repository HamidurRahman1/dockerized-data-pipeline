version: '3'

services:
  airflow-common:
    &airflow-common
    build:
      context: ./dockerfiles
      dockerfile: DDP-apache-airflow
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: $AIRFLOW_DB_URL
    volumes:
      - $MOUNT_VOL/scripts:/scripts
      - $MOUNT_VOL/data/landing:/data/landing
      - $MOUNT_VOL/data/processed:/data/processed
      - $MOUNT_VOL/data/archive:/data/archive
      - $MOUNT_VOL/dags:/opt/airflow/dags
      - $MOUNT_VOL/logs:/opt/airflow/logs
    depends_on:
      - airflow-postgres-metadb

  airflow-postgres-metadb:
    image: postgres:15
    environment:
      POSTGRES_USER: ${AIRFLOW_META_DB_USERNAME}
      POSTGRES_PASSWORD: ${AIRFLOW_META_DB_PASS}
      POSTGRES_DB: ${AIRFLOW_META_DB}
      TZ: 'America/New_York'
      PGTZ: 'America/New_York'
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "${AIRFLOW_META_DB_USERNAME}" ]
      interval: 30s
      retries: 3
    ports:
      - "5000:5432"
    volumes:
      - ${MOUNT_VOL}/pgdata/airflow-metadb:/var/lib/postgresql/data
    restart: always
    networks:
      - ddp

  airflow-webserver:
    <<: *airflow-common
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db init;
        airflow users create --role Admin --username ${AIRFLOW_WEBSERVER_USERNAME} --password ${AIRFLOW_WEBSERVER_PASS} \
          --firstname Hamidur --lastname Rahman --email admin@example.com;
        airflow webserver;
    ports:
      - "8000:8080"
    restart: always
    depends_on:
      - airflow-postgres-metadb
    networks:
      - ddp

networks:
  ddp: